// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  student
  teacher
  admin
  report_viewer
}

enum AttendanceStatus {
  present
  absent
}

enum CourseType {
  core
  department_elective
  open_elective
}

// Models
model College {
  id      String  @id @default(uuid()) @map("college_id") @db.Uuid
  name    String  @unique @map("college_name") @db.VarChar(150)
  code    String  @unique @map("college_code") @db.VarChar(20)
  logoUrl String? @map("logo_url")

  @@map("colleges")
}

model Department {
  id   String  @id @default(uuid()) @map("department_id") @db.Uuid
  name String  @unique @map("department_name") @db.VarChar(100)
  code String? @unique @map("department_code") @db.VarChar(10)

  // Relations
  teachers                 Teacher[]
  courses                  Course[]
  departmentElectiveGroups DepartmentElectiveGroup[]
  openElectiveRestrictions OpenElectiveRestriction[]
  courseOfferings          CourseOffering[]

  @@map("departments")
}

model User {
  id           String   @id @default(uuid()) @map("user_id") @db.Uuid
  username     String   @unique @db.VarChar(100)
  passwordHash String   @map("password_hash")
  name         String   @db.VarChar(100)
  phone        String?  @db.VarChar(15)
  photoUrl     String?  @map("photo_url")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  userRoles    UserRoleAssignment[]
  student      Student?
  teacher      Teacher?
  admin        Admin?
  reportViewer ReportViewer?

  @@map("users")
}

model UserRoleAssignment {
  userId String   @map("user_id") @db.Uuid
  role   UserRole

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, role])
  @@map("user_roles")
}

model Student {
  id        String @id @default(uuid()) @map("student_id") @db.Uuid
  userId    String @unique @map("user_id") @db.Uuid
  usn       String @unique @db.VarChar(20)
  batchYear Int    @map("batch_year")
  semester  Int?

  // Relations
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  enrollments       StudentEnrollment[]
  attendanceRecords AttendanceRecord[]

  @@index([userId])
  @@map("students")
}

model Teacher {
  id           String  @id @default(uuid()) @map("teacher_id") @db.Uuid
  userId       String  @unique @map("user_id") @db.Uuid
  departmentId String? @map("department_id") @db.Uuid

  // Relations
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  department      Department?      @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  courseOfferings CourseOffering[]
  attendances     Attendance[]

  @@index([userId])
  @@index([departmentId])
  @@map("teachers")
}

model Course {
  id                 String      @id @default(uuid()) @map("course_id") @db.Uuid
  code               String      @unique @map("course_code") @db.VarChar(20)
  name               String      @map("course_name") @db.VarChar(100)
  departmentId       String?     @map("department_id") @db.Uuid
  type               CourseType? @map("course_type")
  hasTheoryComponent Boolean     @default(true) @map("has_theory_component")
  hasLabComponent    Boolean     @default(false) @map("has_lab_component")

  // Relations
  department                 Department?                 @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  courseElectiveGroupMembers CourseElectiveGroupMember[]
  openElectiveRestrictions   OpenElectiveRestriction[]
  courseOfferings            CourseOffering[]

  @@index([departmentId])
  @@map("courses")
}

model DepartmentElectiveGroup {
  id           String @id @default(uuid()) @map("group_id") @db.Uuid
  name         String @map("group_name") @db.VarChar(150)
  departmentId String @map("department_id") @db.Uuid
  semester     Int
  batchYear    Int    @map("batch_year")

  // Relations
  department                 Department                  @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  courseElectiveGroupMembers CourseElectiveGroupMember[]

  @@unique([name, departmentId, semester, batchYear], map: "unique_group_dept_sem_batch")
  @@map("department_elective_groups")
}

model CourseElectiveGroupMember {
  groupId  String @map("group_id") @db.Uuid
  courseId String @map("course_id") @db.Uuid

  // Relations
  group  DepartmentElectiveGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  course Course                  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@id([groupId, courseId])
  @@map("course_elective_group_members")
}

model OpenElectiveRestriction {
  id                     String @id @default(uuid()) @map("restriction_id") @db.Uuid
  courseId               String @map("course_id") @db.Uuid
  restrictedDepartmentId String @map("restricted_department_id") @db.Uuid

  // Relations
  course               Course     @relation(fields: [courseId], references: [id], onDelete: Cascade)
  restrictedDepartment Department @relation(fields: [restrictedDepartmentId], references: [id], onDelete: Cascade)

  @@unique([courseId, restrictedDepartmentId])
  @@index([courseId])
  @@map("open_elective_restrictions")
}

model CourseOffering {
  id           String  @id @default(uuid()) @map("offering_id") @db.Uuid
  courseId     String? @map("course_id") @db.Uuid
  teacherId    String? @map("teacher_id") @db.Uuid
  classSection String? @map("class_section") @db.VarChar(10)
  batchYear    Int?    @map("batch_year")
  semester     Int?
  departmentId String? @map("department_id") @db.Uuid

  // Relations
  course      Course?             @relation(fields: [courseId], references: [id], onDelete: Cascade)
  teacher     Teacher?            @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  department  Department?         @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  enrollments StudentEnrollment[]
  attendances Attendance[]

  @@index([departmentId])
  @@map("course_offerings")
}

model StudentEnrollment {
  id            String  @id @default(uuid()) @map("enrollment_id") @db.Uuid
  studentId     String? @map("student_id") @db.Uuid
  offeringId    String? @map("offering_id") @db.Uuid
  attemptNumber Int?    @default(1) @map("attempt_number")
  batchYear     Int?    @map("batch_year")

  // Relations
  student     Student?        @relation(fields: [studentId], references: [id], onDelete: Cascade)
  offering    CourseOffering? @relation(fields: [offeringId], references: [id], onDelete: Cascade)
  theoryMarks TheoryMarks?
  labMarks    LabMarks?

  @@map("student_enrollments")
}

model Attendance {
  id              String   @id @default(uuid()) @map("attendance_id") @db.Uuid
  offeringId      String?  @map("offering_id") @db.Uuid
  teacherId       String?  @map("teacher_id") @db.Uuid
  classDate       DateTime @map("class_date") @db.Date
  periodNumber    Int?     @map("period_number")
  syllabusCovered String?  @map("syllabus_covered")

  // Relations
  offering          CourseOffering?    @relation(fields: [offeringId], references: [id], onDelete: Cascade)
  teacher           Teacher?           @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  attendanceRecords AttendanceRecord[]

  @@map("attendance")
}

model AttendanceRecord {
  id           String            @id @default(uuid()) @map("record_id") @db.Uuid
  attendanceId String?           @map("attendance_id") @db.Uuid
  studentId    String?           @map("student_id") @db.Uuid
  status       AttendanceStatus?

  // Relations
  attendance Attendance? @relation(fields: [attendanceId], references: [id], onDelete: Cascade)
  student    Student?    @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("attendance_records")
}

model TheoryMarks {
  id            String   @id @default(uuid()) @map("marks_id") @db.Uuid
  enrollmentId  String   @unique @map("enrollment_id") @db.Uuid
  mse1Marks     Int?     @map("mse1_marks") @db.SmallInt
  mse2Marks     Int?     @map("mse2_marks") @db.SmallInt
  mse3Marks     Int?     @map("mse3_marks") @db.SmallInt
  task1Marks    Int?     @map("task1_marks") @db.SmallInt
  task2Marks    Int?     @map("task2_marks") @db.SmallInt
  task3Marks    Int?     @map("task3_marks") @db.SmallInt
  lastUpdatedAt DateTime @default(now()) @map("last_updated_at")

  // Relations
  enrollment StudentEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@map("theory_marks")
}

model LabMarks {
  id                        String   @id @default(uuid()) @map("marks_id") @db.Uuid
  enrollmentId              String   @unique @map("enrollment_id") @db.Uuid
  recordMarks               Int?     @map("record_marks") @db.SmallInt
  continuousEvaluationMarks Int?     @map("continuous_evaluation_marks") @db.SmallInt
  labMseMarks               Int?     @map("lab_mse_marks") @db.SmallInt
  lastUpdatedAt             DateTime @default(now()) @map("last_updated_at")

  // Relations
  enrollment StudentEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@map("lab_marks")
}

model Admin {
  id     String @id @default(uuid()) @map("admin_id") @db.Uuid
  userId String @unique @map("user_id") @db.Uuid

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("admins")
}

model ReportViewer {
  id     String @id @default(uuid()) @map("viewer_id") @db.Uuid
  userId String @unique @map("user_id") @db.Uuid

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("report_viewers")
}
